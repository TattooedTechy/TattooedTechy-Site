name: Deploy and Auto-Update IPNS

on:
  push:
    branches:
      - master # Run this workflow on pushes to the master branch

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # --- 1. DEPLOY TO IPFS (GET NEW CID) ---
      - name: Deploy Site and Pin Content
        uses: anantaramdas/ipfs-pinata-deploy-action@v1.6.4
        id: pinata_deploy
        with:
          pin-name: 'TattooedTechy-Hub-Latest'
          path: './' # Upload the entire repository root
          pinata-api-key: ${{ secrets.PINATA_API_KEY }}
          pinata-secret-api-key: ${{ secrets.PINATA_SECRET_API_KEY }}
          remove-old: true

      # --- 2. SETUP NODE.JS ENVIRONMENT ---
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18' 

      - name: Install dependencies (axios)
        run: npm install axios

      # --- 3. UPDATE IPNS (RUN CUSTOM SCRIPT) ---
      - name: Publish New CID to IPNS Key
        run: node ipns_publisher.js
        env:
          PINATA_JWT_TOKEN: ${{ secrets.PINATA_JWT_TOKEN }}
          IPNS_HASH: ${{ secrets.IPNS_HASH }}
          NEW_CID: ${{ steps.pinata_deploy.outputs.cid }}