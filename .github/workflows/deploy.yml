name: Deploy and Auto-Update IPNS

on:
  push:
    branches:
      - master # Run this workflow on pushes to the master branch

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # --- 1. DEPLOY TO IPFS (GET NEW CID) ---
      - name: Deploy Site and Pin Content
        uses: anantaramdas/ipfs-pinata-deploy-action@v1.6.4
        id: pinata_deploy
        with:
          pin-name: 'TattooedTechy-Hub-Latest'
          path: './' # Upload the entire repository root
          pinata-api-key: ${{ secrets.PINATA_API_KEY }}
          pinata-secret-api-key: ${{ secrets.PINATA_SECRET_API_KEY }}
          remove-old: true

      # --- 2. UPDATE IPNS (FORCE PUBLISH TO ALIAS) ---
      # We use a second action to handle the complex IPNS publishing function.
      - name: Publish New CID to IPNS Key
        uses: satyambhatnagar/pinata-ipns-publish@v1.0.0 # Dedicated IPNS publishing action
        with:
          jwt: ${{ secrets.PINATA_JWT_TOKEN }} # NOTE: This action requires the JWT!
          name: TattooedTechy-IPNS-Alias
          ipfs_path: ${{ steps.pinata_deploy.outputs.cid }}