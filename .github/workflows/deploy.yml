name: Direct API Deployment & IPNS Update

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # --- 1. INSTALL UTILITIES & COMPRESS FILES ---
      - name: Install dependencies (tar)
        run: sudo apt-get install -y tar # Ensures tar is available for file bundling

      - name: Bundle Project Files (Tar Archive)
        # Create a compressed tar archive of the project root
        run: tar -czf site_archive.tar.gz .

# --- 2. DEPLOY TO IPFS (GET NEW CID) ---
      # Uses a multi-part form request to upload the file bundle to Pinata's API
      - name: Upload and Pin New CID
        id: pinata_upload
        run: |
          # Use curl to upload the bundled archive, using JWT for Authorization
          UPLOAD_RESPONSE=$(curl -X POST 'https://api.pinata.cloud/pinning/pinFileToIPFS' \
            -H 'Authorization: Bearer ${{ secrets.PINATA_JWT_TOKEN }}' \
            -F file=@site_archive.tar.gz \
            -F 'pinataMetadata={"name":"TattooedTechy-Hub-Latest"}' \
            -F 'pinataOptions={"cidVersion":1}')
          
          # Extract CID from the JSON response
          NEW_CID=$(echo "$UPLOAD_RESPONSE" | grep -o '"IpfsHash":"[^"]*"' | cut -d ':' -f 2 | tr -d '"')
          
          if [ -z "$NEW_CID" ]; then
            echo "Error: Failed to retrieve CID from Pinata upload response."
            # Pinata often returns error messages inside 'error' or 'message' fields.
            ERROR_MESSAGE=$(echo "$UPLOAD_RESPONSE" | grep -o '"error":"[^"]*"' | cut -d ':' -f 2 | tr -d '"')
            if [ -z "$ERROR_MESSAGE" ]; then
                ERROR_MESSAGE=$(echo "$UPLOAD_RESPONSE" | grep -o '"message":"[^"]*"' | cut -d ':' -f 2 | tr -d '"')
            fi

            echo "Pinata Error Response: $ERROR_MESSAGE"
            exit 1
          fi
          
          # Set the NEW_CID as an environment variable for the next step (IPNS)
          echo "NEW_CID=$NEW_CID" >> $GITHUB_ENV
          echo "âœ… New CID Retrieved: $NEW_CID"

      # --- 3. UPDATE IPNS (SET PERMANENT ALIAS) ---
      - name: Publish New CID to IPNS Key
        run: |
          echo "Starting IPNS publish for CID: ${{ env.NEW_CID }}"
          
          # This API call tells Pinata to update the existing IPNS hash to point to the new CID
          IPNS_PUBLISH_RESPONSE=$(curl -X PUT 'https://api.pinata.cloud/pinning/updateIpnsKey' \
            -H 'Authorization: Bearer ${{ secrets.PINATA_JWT_TOKEN }}' \
            -H 'Content-Type: application/json' \
            -d '{
              "name": "TattooedTechy-IPNS-Alias",
              "hashToPin": "${{ env.NEW_CID }}"
            }')
          
          echo "IPNS Publishing Request Sent."
          echo "Response: $IPNS_PUBLISH_RESPONSE"
          echo "Check Pinata IPNS section for final confirmation of k51q hash update."