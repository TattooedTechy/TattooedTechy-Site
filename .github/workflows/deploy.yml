name: Deploy and Update IPNS

on:
  push:
    branches:
      - master # Run this workflow on pushes to the master branch

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # --- 1. DEPLOY TO IPFS (GET NEW CID) ---
      - name: Deploy to IPFS
        uses: anantaramdas/ipfs-pinata-deploy-action@v1.6.4
        id: pinata_deploy
        with:
          pin-name: 'TattooedTechy-Hub-Latest'
          path: './' # Upload the entire repository root
          pinata-api-key: ${{ secrets.PINATA_API_KEY }}
          pinata-secret-api-key: ${{ secrets.PINATA_SECRET_API_KEY }}
          remove-old: true

      # --- 2. UPDATE IPNS (SET PERMANENT ALIAS) ---
      - name: Update IPNS Key to New CID
        # This uses the Pinata API to update the IPNS record using the new CID
        # We use the standard API Key/Secret pair for compatibility with the curl command
        run: |
          echo "New CID: ${{ steps.pinata_deploy.outputs.cid }}"
          curl --location --request POST 'https://api.pinata.cloud/pinning/hashToIPFS' \
          --header 'Content-Type: application/json' \
          --header 'pinata_api_key: ${{ secrets.PINATA_API_KEY }}' \
          --header 'pinata_secret_api_key: ${{ secrets.PINATA_SECRET_API_KEY }}' \
          --data-raw '{
              "hashToPin": "${{ steps.pinata_deploy.outputs.cid }}",
              "pinataOptions": {
                  "cidVersion": 1
              },
              "pinataMetadata": {
                  "name": "${{ secrets.IPNS_HASH }}"
              }
          }'
        env:
          IPFS_CID: ${{ steps.pinata_deploy.outputs.cid }} 