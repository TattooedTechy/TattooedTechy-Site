name: Deploy and Auto-Update IPNS

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # --- 1. DEPLOY TO IPFS (USE HIGHLY STABLE ACTION) ---
      # This action is often maintained and uses the latest environment variables.
      - name: Deploy Site and Pin Content
        uses: anhvudotnet/github-action-pinata@master # Use master branch resolution
        id: pinata_deploy
        with:
          pinata-api-key: ${{ secrets.PINATA_API_KEY }}
          pinata-secret-api-key: ${{ secrets.PINATA_SECRET_API_KEY }}
          source-path: './' # The root folder of your site
          pin-name: 'TattooedTechy-Hub-Latest'

      # --- 2. SETUP NODE.JS ENVIRONMENT ---
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18' 

      - name: Install dependencies (axios)
        run: npm install axios

      - name: Publish New CID to IPNS Key
        run: node ipns_publisher.js
        env:
          PINATA_JWT_TOKEN: ${{ secrets.PINATA_JWT_TOKEN }}
          IPNS_HASH: ${{ secrets.IPNS_HASH }}
          # Output name convention for this action is usually 'cid', but may be 'ipfsHash' or 'ipfs_hash'
          NEW_CID: ${{ steps.pinata_deploy.outputs.ipfs_hash }}